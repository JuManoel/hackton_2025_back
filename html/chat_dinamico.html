<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IngeLean AI Chat - Sistema Din√°mico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .typing-indicator {
            display: inline-block;
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0%, 20% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .message-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .chat-item {
            transition: all 0.2s ease;
        }
        
        .chat-item:hover {
            background-color: #f3f4f6;
        }
        
        .chat-item.active {
            background-color: #3b82f6;
            color: white;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans">
    <!-- Header -->
    <header class="bg-black shadow-lg">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-center">
                <h1 class="text-white text-2xl font-bold">IngeLean AI Chat</h1>
            </div>
        </div>
    </header>

    <!-- Contenido principal -->
    <div class="p-5">
        <div class="max-w-7xl mx-auto bg-white rounded-lg shadow-md overflow-hidden">
            <div class="flex h-[600px]">
                <!-- Panel lateral de chats -->
                <div class="w-80 bg-gray-50 border-r border-gray-200 flex flex-col">
                    <!-- Header del panel de chats -->
                    <div class="p-4 bg-gray-100 border-b border-gray-200">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-lg font-semibold text-gray-800">Chats</h2>
                            <button
                                id="newChatBtn"
                                class="px-3 py-1 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors text-sm"
                            >
                                + Nuevo Chat
                            </button>
                        </div>
                        <div id="chatStatus" class="text-sm text-gray-600">
                            Cargando chats...
                        </div>
                    </div>
                    
                    <!-- Lista de chats -->
                    <div class="flex-1 overflow-y-auto">
                        <div id="chatsList" class="p-2">
                            <!-- Los chats se cargar√°n aqu√≠ din√°micamente -->
                        </div>
                    </div>
                </div>

                <!-- Panel principal del chat -->
                <div class="flex-1 flex flex-col">
                    <!-- Header del chat actual -->
                    <div class="p-4 bg-white border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 id="currentChatTitle" class="text-lg font-semibold text-gray-800">
                                    Selecciona un chat
                                </h3>
                                <p id="currentChatId" class="text-sm text-gray-500">
                                    No hay chat seleccionado
                                </p>
                            </div>
                            <div class="flex items-center gap-2">
                                <div id="connectionStatus" class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm">
                                    Conectando...
                                </div>
                                <button
                                    id="debugToggle"
                                    class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors text-sm"
                                >
                                    Debug
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- √Årea de mensajes -->
                    <div class="flex-1 overflow-y-auto p-4 bg-gray-50">
                        <div id="messagesList" class="space-y-4 max-w-4xl mx-auto">
                            <!-- Mensaje de bienvenida -->
                            <div class="flex justify-start">
                                <div class="max-w-[80%] bg-blue-500 text-white p-3 rounded-lg rounded-bl-sm">
                                    <div class="font-semibold text-sm mb-1">Johan - IngeLean</div>
                                    <div>¬°Hola! Soy Johan, tu asistente virtual de IngeLean. Crea un nuevo chat o selecciona uno existente para comenzar. ¬øEn qu√© puedo ayudarte hoy? üòä</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status del streaming -->
                    <div id="streamingStatus" class="mx-4 mb-2 p-2 bg-blue-50 border border-blue-200 rounded-md hidden">
                        <div class="flex items-center text-blue-700">
                            <span class="typing-indicator mr-2">‚óè</span>
                            <span>Johan est√° escribiendo...</span>
                        </div>
                    </div>

                    <!-- Input area -->
                    <div class="p-4 bg-white border-t border-gray-200">
                        <div class="max-w-4xl mx-auto">
                            <div class="flex gap-2">
                                <input
                                    id="messageInput"
                                    type="text"
                                    placeholder="Escribe tu mensaje aqu√≠... (Selecciona un chat primero)"
                                    class="flex-1 p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
                                    disabled
                                />
                                <button
                                    id="micBtn"
                                    class="px-4 py-2 bg-gray-400 text-white rounded-md transition-colors flex items-center justify-center disabled:opacity-50"
                                    title="Voz a texto"
                                    disabled
                                >
                                    <svg id="micIcon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path>
                                    </svg>
                                    <svg id="stopIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                                <button
                                    id="sendBtn"
                                    class="px-4 py-2 bg-gray-400 text-white rounded-md transition-colors flex items-center justify-center disabled:opacity-50"
                                    disabled
                                >
                                    <svg class="w-5 h-5 rotate-90" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Debug panel (oculto por defecto) -->
            <div id="debugContainer" class="p-4 bg-gray-900 text-green-400 font-mono text-sm hidden">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-white font-bold">Debug Console</h3>
                    <button id="clearDebug" class="px-2 py-1 bg-red-600 text-white rounded text-xs">Clear</button>
                </div>
                <div id="debugLog" class="h-40 overflow-y-auto border border-gray-700 p-2 bg-black rounded">
                    <!-- Debug messages aqu√≠ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_CONFIG = {
            baseUrl: "http://localhost:8000/api",
            endpoints: {
                chats: "/chat",
                messages: "/message"
            }
        };

        // Global variables
        let currentChatId = null;
        let isStreaming = false;
        let recognition = null;
        let isRecording = false;

        // DOM Elements
        const chatsList = document.getElementById("chatsList");
        const messagesList = document.getElementById("messagesList");
        const messageInput = document.getElementById("messageInput");
        const sendBtn = document.getElementById("sendBtn");
        const micBtn = document.getElementById("micBtn");
        const micIcon = document.getElementById("micIcon");
        const stopIcon = document.getElementById("stopIcon");
        const newChatBtn = document.getElementById("newChatBtn");
        const streamingStatus = document.getElementById("streamingStatus");
        const currentChatTitle = document.getElementById("currentChatTitle");
        const currentChatId_display = document.getElementById("currentChatId");
        const connectionStatus = document.getElementById("connectionStatus");
        const chatStatus = document.getElementById("chatStatus");
        const debugContainer = document.getElementById("debugContainer");
        const debugLog = document.getElementById("debugLog");
        const debugToggle = document.getElementById("debugToggle");
        const clearDebug = document.getElementById("clearDebug");

        // Debug functions
        function debugLog_func(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': 'text-green-400',
                'error': 'text-red-400',
                'success': 'text-blue-400',
                'warning': 'text-yellow-400'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = colors[type] || 'text-green-400';
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`);
        }

        // Status functions
        function updateConnectionStatus(status, type = 'info') {
            const colors = {
                'success': 'bg-green-100 text-green-700',
                'error': 'bg-red-100 text-red-700',
                'warning': 'bg-yellow-100 text-yellow-700',
                'info': 'bg-blue-100 text-blue-700'
            };
            
            connectionStatus.className = `px-3 py-1 rounded-full text-sm ${colors[type]}`;
            connectionStatus.textContent = status;
        }

        function updateChatStatus(status) {
            chatStatus.textContent = status;
        }

        // Chat functions
        async function loadChats() {
            try {
                debugLog_func("Cargando lista de chats...");
                updateChatStatus("Cargando chats...");
                
                const response = await fetch(`${API_CONFIG.baseUrl}${API_CONFIG.endpoints.chats}/`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayChats(data.data);
                    updateChatStatus(`${data.total} chats encontrados`);
                    debugLog_func(`Chats cargados exitosamente: ${data.total}`, 'success');
                } else {
                    throw new Error(data.message || 'Error al cargar chats');
                }
            } catch (error) {
                debugLog_func(`Error al cargar chats: ${error.message}`, 'error');
                updateChatStatus("Error al cargar chats");
                updateConnectionStatus("Error de conexi√≥n", 'error');
            }
        }

        function displayChats(chats) {
            chatsList.innerHTML = '';
            
            if (chats.length === 0) {
                chatsList.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        <p>No hay chats a√∫n</p>
                        <p class="text-sm">Crea uno nuevo para empezar</p>
                    </div>
                `;
                return;
            }
            
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item p-3 rounded-md cursor-pointer border border-transparent';
                chatItem.dataset.chatId = chat.id;
                
                const lastMessage = chat.last_message;
                const messagePreview = lastMessage ? 
                    `[${lastMessage.role}] ${lastMessage.content}` : 
                    'Chat vac√≠o';
                
                chatItem.innerHTML = `
                    <div class="font-medium text-sm text-gray-800">
                        Chat ${chat.id.slice(-6)}
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        ${chat.message_count} mensajes
                    </div>
                    <div class="text-xs text-gray-400 mt-1 truncate">
                        ${messagePreview}
                    </div>
                `;
                
                chatItem.addEventListener('click', () => selectChat(chat.id));
                chatsList.appendChild(chatItem);
            });
        }

        async function createNewChat() {
            try {
                debugLog_func("Creando nuevo chat...");
                newChatBtn.disabled = true;
                newChatBtn.textContent = "Creando...";
                
                const response = await fetch(`${API_CONFIG.baseUrl}${API_CONFIG.endpoints.chats}/`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    debugLog_func(`Nuevo chat creado: ${data.data.id}`, 'success');
                    await loadChats(); // Recargar lista
                    selectChat(data.data.id); // Seleccionar el nuevo chat
                } else {
                    throw new Error(data.message || 'Error al crear chat');
                }
            } catch (error) {
                debugLog_func(`Error al crear chat: ${error.message}`, 'error');
                alert('Error al crear nuevo chat. Verifica la conexi√≥n.');
            } finally {
                newChatBtn.disabled = false;
                newChatBtn.textContent = "+ Nuevo Chat";
            }
        }

        async function selectChat(chatId) {
            if (currentChatId === chatId) return;
            
            try {
                debugLog_func(`Seleccionando chat: ${chatId}`);
                
                // Actualizar UI
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const selectedItem = document.querySelector(`[data-chat-id="${chatId}"]`);
                if (selectedItem) {
                    selectedItem.classList.add('active');
                }
                
                currentChatId = chatId;
                currentChatTitle.textContent = `Chat ${chatId.slice(-6)}`;
                currentChatId_display.textContent = `ID: ${chatId}`;
                
                // Habilitar controles
                messageInput.disabled = false;
                messageInput.placeholder = "Escribe tu mensaje aqu√≠...";
                sendBtn.disabled = false;
                sendBtn.classList.remove('bg-gray-400');
                sendBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                micBtn.disabled = false;
                micBtn.classList.remove('bg-gray-400');
                micBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                
                // Cargar historial
                await loadChatHistory(chatId);
                
                debugLog_func(`Chat seleccionado exitosamente: ${chatId}`, 'success');
            } catch (error) {
                debugLog_func(`Error al seleccionar chat: ${error.message}`, 'error');
            }
        }

        async function loadChatHistory(chatId) {
            try {
                debugLog_func(`Cargando historial del chat: ${chatId}`);
                
                const response = await fetch(`${API_CONFIG.baseUrl}${API_CONFIG.endpoints.messages}/chat/${chatId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayMessages(data.data);
                    debugLog_func(`Historial cargado: ${data.total} mensajes`, 'success');
                } else {
                    // Si no hay mensajes, simplemente limpiar el √°rea
                    clearMessages();
                    debugLog_func(`Chat sin historial: ${chatId}`, 'info');
                }
            } catch (error) {
                debugLog_func(`Error al cargar historial: ${error.message}`, 'error');
                clearMessages();
            }
        }

        function displayMessages(messages) {
            clearMessages();
            
            messages.forEach(message => {
                addMessageToUI(message.content, message.role, false);
            });
        }

        function clearMessages() {
            messagesList.innerHTML = '';
        }

        function addMessageToUI(text, sender = 'user', isTyping = false) {
            const messageDiv = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex justify-end">
                        <div class="max-w-[80%] bg-gray-600 text-white p-3 rounded-lg rounded-br-sm">
                            <div class="message-content">${text}</div>
                            <div class="text-xs opacity-70 mt-1">${timestamp}</div>
                        </div>
                    </div>
                `;
            } else {
                const typingClass = isTyping ? 'typing-indicator' : '';
                messageDiv.innerHTML = `
                    <div class="flex justify-start">
                        <div class="max-w-[80%] bg-blue-500 text-white p-3 rounded-lg rounded-bl-sm">
                            <div class="font-semibold text-sm mb-1">Johan - IngeLean</div>
                            <div class="message-content ${typingClass}">${text || 'Escribiendo...'}</div>
                            ${!isTyping ? `<div class="text-xs opacity-70 mt-1">${timestamp}</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            messagesList.appendChild(messageDiv);
            messagesList.scrollTop = messagesList.scrollHeight;
            
            return messageDiv.querySelector('.message-content');
        }

        // Message sending
        async function sendMessage() {
            if (!currentChatId || isStreaming) return;
            
            const text = messageInput.value.trim();
            if (!text) return;
            
            try {
                isStreaming = true;
                messageInput.value = "";
                messageInput.disabled = true;
                sendBtn.disabled = true;
                
                // Agregar mensaje del usuario
                addMessageToUI(text, 'user');
                
                // Mostrar indicador de typing
                streamingStatus.classList.remove('hidden');
                const responseContainer = addMessageToUI('', 'assistant', true);
                
                debugLog_func(`Enviando mensaje al chat ${currentChatId}: ${text.substring(0, 50)}...`);
                
                // Hacer petici√≥n con streaming
                const response = await fetch(`${API_CONFIG.baseUrl}${API_CONFIG.endpoints.messages}/chat/${currentChatId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream'
                    },
                    body: JSON.stringify({ content: text })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Procesar streaming
                let fullResponse = '';
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.type === 'content' && data.content) {
                                    fullResponse += data.content;
                                    responseContainer.textContent = fullResponse;
                                    responseContainer.classList.remove('typing-indicator');
                                } else if (data.type === 'done') {
                                    debugLog_func(`Respuesta completada (${fullResponse.length} caracteres)`, 'success');
                                    break;
                                } else if (data.type === 'error') {
                                    throw new Error(data.error || 'Error en streaming');
                                }
                            } catch (parseError) {
                                debugLog_func(`Error al parsear chunk: ${parseError.message}`, 'warning');
                            }
                        }
                    }
                }
                
                // Recargar lista de chats para actualizar preview
                await loadChats();
                
            } catch (error) {
                debugLog_func(`Error al enviar mensaje: ${error.message}`, 'error');
                addMessageToUI(`Error: ${error.message}`, 'assistant');
            } finally {
                isStreaming = false;
                streamingStatus.classList.add('hidden');
                messageInput.disabled = false;
                sendBtn.disabled = false;
                messageInput.focus();
            }
        }

        // Speech recognition
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'es-ES';
                
                recognition.onstart = () => {
                    isRecording = true;
                    micIcon.classList.add('hidden');
                    stopIcon.classList.remove('hidden');
                    micBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                    micBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    debugLog_func("Reconocimiento de voz iniciado");
                };
                
                recognition.onresult = (event) => {
                    let finalTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        }
                    }
                    if (finalTranscript) {
                        messageInput.value = finalTranscript;
                        debugLog_func(`Texto reconocido: ${finalTranscript}`);
                    }
                };
                
                recognition.onend = () => {
                    isRecording = false;
                    micIcon.classList.remove('hidden');
                    stopIcon.classList.add('hidden');
                    micBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                    micBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                };
                
                recognition.onerror = (event) => {
                    debugLog_func(`Error de reconocimiento: ${event.error}`, 'error');
                };
                
                return true;
            }
            return false;
        }

        function toggleSpeechRecognition() {
            if (!recognition || !currentChatId) return;
            
            if (isRecording) {
                recognition.stop();
            } else {
                messageInput.value = '';
                recognition.start();
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async () => {
            debugLog_func("Iniciando aplicaci√≥n...", 'info');
            
            // Verificar conexi√≥n
            try {
                const response = await fetch(`${API_CONFIG.baseUrl.replace('/api', '')}/health`);
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    updateConnectionStatus("Conectado", 'success');
                    debugLog_func("Conexi√≥n al servidor exitosa", 'success');
                } else {
                    throw new Error('Servidor no saludable');
                }
            } catch (error) {
                updateConnectionStatus("Sin conexi√≥n", 'error');
                debugLog_func(`Error de conexi√≥n: ${error.message}`, 'error');
            }
            
            // Cargar chats
            await loadChats();
            
            // Inicializar reconocimiento de voz
            if (initializeSpeechRecognition()) {
                debugLog_func("Reconocimiento de voz habilitado", 'success');
            } else {
                debugLog_func("Reconocimiento de voz no disponible", 'warning');
                micBtn.disabled = true;
                micBtn.classList.add('opacity-50');
            }
            
            debugLog_func("Aplicaci√≥n iniciada exitosamente", 'success');
        });

        // Event listeners
        newChatBtn.addEventListener('click', createNewChat);
        sendBtn.addEventListener('click', sendMessage);
        micBtn.addEventListener('click', toggleSpeechRecognition);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        debugToggle.addEventListener('click', () => {
            debugContainer.classList.toggle('hidden');
        });
        
        clearDebug.addEventListener('click', () => {
            debugLog.innerHTML = '';
        });
    </script>
</body>
</html>
